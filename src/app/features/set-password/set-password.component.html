<app-page-wrapper>
  <p-button
    icon="pi pi-arrow-left"
    label="Volver"
    variant="text"
    severity="secondary"
    (onClick)="onClickBack()"
  />

  <div class="set-password-container">
    <div class="page-title">
      <div class="page-title-top">
        <div class="font-32 font-w-700">Establecer contraseña</div>
      </div>
      <div>Introduce tu nueva contraseña para acceder a la plataforma</div>
    </div>

    <div *ngIf="!isValidating && !isTokenValid" class="titled-container">
      <div class="notice c-red">
        <i class="pi pi-times-circle"></i>
        <div>
          El enlace es <strong>inválido o ha caducado</strong>. Vuelve a solicitar un nuevo enlace de restablecimiento.
        </div>
      </div>

      <div class="actions-row">
        <p-button label="Ir a Login" severity="primary" (onClick)="onClickGoLogin()" />
      </div>
    </div>

    <div *ngIf="isValidating" class="titled-container">
      <div class="notice c-blue">
        <i class="pi pi-spinner spin"></i>
        <div>Validando enlace...</div>
      </div>
    </div>


    <div *ngIf="!isValidating && isTokenValid" class="set-password-form-container">
      <div class="titled-container">
        <div class="font-16 font-w-600">Contraseña *</div>

        <div class="info-form-container">
          <div class="notice c-blue">
            <i class="pi pi-info-circle"></i>
            <div>
              Tu contraseña debe tener <strong>al menos 8 caracteres</strong> e incluir <strong>letras y números</strong>.
            </div>
          </div>
        </div>

        <div class="form-container" [formGroup]="form">
          <p-floatlabel class="form-input" variant="on">
            <input pInputText [type]="show1 ? 'text' : 'password'" autocomplete="new-password" formControlName="password" />
            <label>Nueva contraseña</label>
          </p-floatlabel>
          <p-button [text]="true" [rounded]="true" icon="{{show1 ? 'pi pi-eye-slash' : 'pi pi-eye'}}" (onClick)="show1 = !show1" />

          <p-floatlabel class="form-input" variant="on">
            <input pInputText [type]="show2 ? 'text' : 'password'" autocomplete="new-password" formControlName="confirmPassword" />
            <label>Repite la contraseña</label>
          </p-floatlabel>
          <p-button [text]="true" [rounded]="true" icon="{{show2 ? 'pi pi-eye-slash' : 'pi pi-eye'}}" (onClick)="show2 = !show2" />
        </div>

        <div class="errors" *ngIf="form.touched || form.dirty">
          <div class="error" *ngIf="form.get('password')?.errors?.['required']">La contraseña es obligatoria.</div>
          <div class="error" *ngIf="form.get('password')?.errors?.['minlength']">Mínimo 8 caracteres.</div>
          <div class="error" *ngIf="form.get('password')?.errors?.['pattern']">
            Debe incluir letras y números.
          </div>
          <div class="error" *ngIf="form.errors?.['mismatch']">Las contraseñas no coinciden.</div>
        </div>
      </div>

      <p-button
        label="Establecer contraseña"
        severity="primary"
        [disabled]="!form.valid"
        (onClick)="modalVisible = true"
      />
    </div>
  </div>
</app-page-wrapper>

<app-modal [title]="'Establecer contraseña'" [visible]="modalVisible">
  <div class="modal-container">
    <div *ngIf="!isSuccess && !isError" class="modal-icon-container">
      <i *ngIf="!isLoading" class="pi pi-key" style="font-size: 128px"></i>
      <i *ngIf="isLoading" class="pi pi-spinner spin" style="font-size: 128px"></i>
      <div class="font-16 font-w-600">
        ¿Confirmas que quieres establecer tu nueva contraseña?
      </div>
      <div class="font-12 text-gray">Se cerrará este proceso y podrás acceder con tu nueva contraseña.</div>
    </div>

    <div *ngIf="isSuccess" class="modal-icon-container">
      <i class="pi pi-check-circle c-green" style="font-size: 128px"></i>
      <div class="font-16 font-w-600">Contraseña establecida correctamente</div>
      <div class="font-12 text-gray">Ya puedes iniciar sesión con tu nueva contraseña.</div>
    </div>

    <div *ngIf="isError" class="modal-icon-container">
      <i class="pi pi-times c-red" style="font-size: 128px"></i>
      <div class="font-16 font-w-600">No se pudo establecer la contraseña</div>
      <div class="font-12 text-gray">{{ errorMessage || 'Inténtalo de nuevo.' }}</div>
    </div>
  </div>

  <!-- Acciones -->
  <div *ngIf="!isSuccess && !isError" class="modal-actions">
    <p-button label="Volver" severity="secondary" (onClick)="modalVisible = false" />
    <p-button label="Confirmar" severity="primary" (onClick)="onConfirmSetPassword()" [loading]="isLoading" />
  </div>

  <div *ngIf="isSuccess" class="modal-actions">
    <div></div>
    <p-button label="Ir a login" severity="primary" (onClick)="onClickGoLogin()" />
  </div>

  <div *ngIf="isError" class="modal-actions">
    <p-button label="Volver" severity="secondary" (onClick)="modalVisible = false" />
    <p-button label="Reintentar" severity="primary" (onClick)="onConfirmSetPassword()" />
  </div>
</app-modal>