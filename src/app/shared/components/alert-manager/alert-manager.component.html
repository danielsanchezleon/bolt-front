<app-page-wrapper>
    <p-button *ngIf="mode == 'create'" icon="pi pi-arrow-left" label="Volver" variant="text" severity="secondary"
        (onClick)="onClickNavigateToCreateAlert()" />

    <p-button *ngIf="mode == 'edit'" icon="pi pi-arrow-left" label="Volver" variant="text" severity="secondary"
        (onClick)="onClickNavigateToAlerts()" />

    <div class="steps-container">
        <div class="font-32 font-w-600">{{this.alertType == 'simple' ? 'Condición simple' : this.alertType ==
            'composite' ? 'Condición compuesta' : this.alertType == 'logs' ? 'Patrones de logs' : 'Baseline'}}</div>
        <app-accordion *ngIf="!isInitialMetricListLoading" [title]="'Paso 1: Configura la consulta'"
            [highlightTitle]="true" [isOpen]="true">

            <div class="consult-configuration-container">
                <div class="indicators-container">
                    <div class="indicator-container" *ngFor="let indicator of indicatorArray.controls; let i = index;"
                        [formGroup]="indicator">
                        <div class="header">
                            <div class="name"><span
                                    class="text-white font-w-700">{{indicator.get('name')?.value}}</span></div>
                            <div *ngIf="this.alertType == 'composite'" class="buttons">
                                <p-button icon="pi pi-plus" severity="primary" (onClick)="createIndicator();" />
                                <p-button *ngIf="indicatorArray.length > 1" icon="pi pi-minus" severity="secondary"
                                    (onClick)="removeIndicator(i);" />
                            </div>
                        </div>
                        <div class="metrics-container">
                            <div class="metric-container"
                                *ngFor="let metric of indicator.controls.metrics.controls; let j = index; let firstMetric = first;"
                                [formGroup]="metric">
                                <div class="id"><span
                                        class="font-12 text-white font-w-700">{{metric.get('id')?.value}}</span></div>
                                <p-select [options]="matOperationOptions" formControlName="operation"
                                    optionLabel="label" appendTo="body" />
                                <p-select class="full-width-selector" [loading]="loadingMetricList"
                                    [options]="metric.get('options')?.value" formControlName="metric" [filter]="true"
                                    (onFilter)="onFilterMetricsChange($event, metric);" optionLabel="metric"
                                    [placeholder]="loadingMetricList ? 'Cargando...' : 'Selecciona una métrica'"
                                    emptyMessage=" " emptyFilterMessage=" " (onChange)="onChangeMetricSelect(i);"
                                    appendTo="body">
                                    <ng-template let-metric #item>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            <div
                                                style="display: flex; flex-direction: row; align-items: center; gap: 8px;">
                                                <div class="font-w-600">{{metric.metric}}</div>
                                                <div
                                                    style="background-color: #2563eb; padding: 1px 5px; border-radius: 8px; color: white;">
                                                    {{metric.table_name}}</div>
                                                <div class="font-w-600 font-12"
                                                    *ngFor="let dimension of metric.dimension.slice(0, 0)"
                                                    style="background-color: #ebebeb; padding: 2px 10px; border-radius: 24px;">
                                                    {{dimension}}</div>
                                                <div *ngIf="metric.dimension.slice(0).length > 0"
                                                    [pTooltip]="metric.dimension.slice(0)" tooltipPosition="top"
                                                    showDelay="250">[···]</div>
                                            </div>
                                        </div>
                                    </ng-template>
                                </p-select>
                                <div class="buttons">
                                    <p-button icon="pi pi-plus" severity="primary"
                                        (onClick)="createMetric(i);" />
                                    <p-button
                                        *ngIf="(indicator.controls.metrics.controls.length > 1 && mode == 'create') || (mode == 'edit' && metric.get('metricId')?.value == null)"
                                        icon="pi pi-minus" severity="secondary"
                                        (onClick)="removeMetric(i, j);" />
                                </div>
                            </div>
                            <div *ngIf="indicator.controls.metrics.controls.at(0)?.get('metric')?.value != undefined"
                                class="metric-result-container">
                                <div class="metric-result">
                                    <div class="final-expression-content">
                                        <div class="font-16 font-w-600">Expresión final:</div>
                                        <div *ngIf="!resultMetricEditionMap.get(i)"
                                            class="metric-result-ids font-16 font-w-600 c-blue" (click)="resultMetricEditionMap.set(i, true);">
                                            <span>{{ resultMetricMap.get(i)! | sanitizeExpression}}</span>
                                            <i class="pi pi-pencil" style="color: lightgray;"></i>
                                        </div>
                                        <input *ngIf="resultMetricEditionMap.get(i)" type="text" pInputText pSize="small" formControlName="finalExpression" maxlength="40" />
                                        <div *ngIf="resultMetricEditionMap.get(i)" style="display: flex; gap: 16px; margin-left: 16px;">
                                            <p-button icon="pi pi-check" [rounded]="true" severity="success" [outlined]="true" title="Guardar cambios" (click)="resultMetricMap.set(i, indicator.get('finalExpression')?.value!); resultMetricEditionMap.set(i, false);" size="small" [disabled]="indicator.get('finalExpression')?.errors || (resultMetricMap.get(i)! == indicator.get('finalExpression')?.value!)" />
                                            <p-button icon="pi pi-times" [rounded]="true" severity="danger" [outlined]="true" title="Cancelar cambios" (click)="indicator.get('finalExpression')?.setValue(resultMetricMap.get(i)!); resultMetricEditionMap.set(i, false);" size="small" [disabled]="!resultMetricMap.get(i)!" />
                                        </div>
                                    </div>
                                    <i class="pi pi-info-circle c-blue" style="cursor: pointer;" [pTooltip]="'Puedes editar la expresión haciendo click sobre ella. Para hacer referencia a una métrica, debes escribir el nombre del indicador, seguido de un punto y el índice numérico de la métrica que quieras (p.e: A.1)'" tooltipPosition="top" showDelay="500"></i>
                                </div>
                                <div *ngIf="indicator.get('finalExpression')?.errors" class="c-red">
                                    Debes introducir una expresión correcta.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div *ngIf="indicatorArray.length > 0 && indicatorArray.at(0).controls.metrics.length > 0 && indicatorArray.at(0).controls.metrics.at(0).get('metric')?.value != null"
                    class="titled-container">
                    <div class="font-16 font-w-600">Agrupaciones</div>
                    <form class="group-by-options" [formGroup]="groupByForm">
                        <p-floatlabel class="full-width-selector" variant="on">
                            <p-multiselect [options]="tagIntersectionOptions" class="full-width-selector"
                                [filter]="true" appendTo="body" formControlName="groupBy"
                                (onChange)="onChangeGroupBy($event);" emptyMessage="No hay dimensiones que mostrar" />
                            <label for="over_label1">Agrupar por</label>
                        </p-floatlabel>
                    </form>
                </div>

                <app-inner-accordion
                    *ngIf="indicatorArray.length > 0 && indicatorArray.at(0).controls.metrics.length > 0 && indicatorArray.at(0).controls.metrics.at(0).get('metric')?.value != null"
                    [title]="'Opciones avanzadas'" [isOpen]="mode == 'edit' ? true : false">
                    <form class="group-by-options" [formGroup]="advancedOptionsForm">
                        <p-floatlabel class="full-width-selector" variant="on">
                            <p-select
                                [pTooltip]="'Intervalo de tiempo sobre el cual se calcula la métrica seleccionada. Ejemplo: Con una ventana de 5 minutos, se calcula la media del uso de CPU durante ese intervalo.'"
                                tooltipPosition="top" showDelay="500" [options]="timeWindowOptions"
                                class="full-width-selector" inputId="over_label1" optionLabel="label" appendTo="body"
                                formControlName="timeWindow" />
                            <label style="display: flex; flex-direction: row; align-items: center; gap: 4px;"
                                for="over_label1">Ventana de tiempo <i class="pi pi-info-circle"
                                    style="font-size: 0.8rem;"></i></label>
                        </p-floatlabel>
                        <p-floatlabel class="full-width-selector" variant="on">
                            <p-select
                                [pTooltip]="'Aquí puedes introducir el número de minutos desde el momento actual que se van a descartar de datos.'"
                                tooltipPosition="top" showDelay="500" [options]="discardTimeOptions"
                                class="full-width-selector" inputId="over_label2" optionLabel="label" appendTo="body"
                                formControlName="discardTime" />
                            <label style="display: flex; flex-direction: row; align-items: center; gap: 4px;"
                                for="over_label2">Descartar últimos minutos <i class="pi pi-info-circle"
                                    style="font-size: 0.8rem;"></i></label>
                        </p-floatlabel>
                        <p-floatlabel class="full-width-selector" variant="on">
                            <p-select
                                [pTooltip]="'Define cada cuánto se ejecuta la evaluación de la métrica. Si la ventana de tiempo es de 5 minutos y la periodicidad es de 1 minuto, se evaluará cada minuto considerando los últimos 5 minutos de datos.'"
                                tooltipPosition="top" showDelay="500" [options]="periodicityOptions"
                                class="full-width-selector" inputId="over_label3" optionLabel="label" appendTo="body"
                                formControlName="periodicity" />
                            <label style="display: flex; flex-direction: row; align-items: center; gap: 4px;"
                                for="over_label3">Periodicidad <i class="pi pi-info-circle"
                                    style="font-size: 0.8rem;"></i></label>
                        </p-floatlabel>
                    </form>
                </app-inner-accordion>
            </div>
        </app-accordion>

        <p-skeleton *ngIf="isInitialMetricListLoading" width="1460px" height="600px" borderRadius="8px" />

        <app-accordion *ngIf="!isInitialMetricListLoading"
            [title]="'Paso 2: Configura las condiciones de salto y recuperación'" [highlightTitle]="true"
            [disabled]="indicatorArray.length == 0 || indicatorArray.at(0).controls.metrics.length == 0"
            [isOpen]="mode == 'edit' ? true : false">
            <div class="step-2-container">
                <div class="font-20 font-w-600">Configurar umbrales de alerta</div>
                <div class="notice c-blue">
                    <i class="pi pi-info-circle"></i>
                    <div>
                        <span class="font-w-700">Importante</span>: las reglas se ejecutan según un orden de
                        precedencia. Si una misma combinación (por ejemplo: OB = España) se repite en varias líneas con
                        el mismo umbral, se aplicará la primera que aparezca. Utiliza las flechas para subir o bajar las
                        reglas y así establecer tu orden de preferencia.
                    </div>
                </div>

                <div class="threshold-container" *ngFor="let condition of conditionArray.controls; let i = index;"
                    [ngStyle]="{'border': ((condition.controls.clauses.at(0).get('comparation')?.value.value == 'MORE_THAN' || condition.controls.clauses.at(0).get('comparation')?.value.value == 'LESS_THAN') && condition.controls.clauses.at(0).get('value')?.value == undefined) || ((condition.controls.clauses.at(0).get('comparation')?.value.value == 'WITHIN_RANGE' || condition.controls.clauses.at(0).get('comparation')?.value.value == 'OUT_OF_RANGE') && (condition.controls.clauses.at(0).get('min')?.value == undefined || condition.controls.clauses.at(0).get('max')?.value == undefined)) ? '2px solid red' : '1px solid lightgray'}">
                    <div class="condition-content">
                        <div class="condition-top">
                            <div class="id-wrapper font-12 font-w-600 text-white">{{condition.get('id')?.value}}</div>
                            <div class="type-buttons-container">
                                <div *ngIf="condition.get('severity')?.value == severityOptions[0] || !isSeveritySelected(severityOptions[0])"
                                    class="type-button-container"
                                    [ngClass]="{'disaster': condition.get('severity')?.value == severityOptions[0], 'text-white': condition.get('severity')?.value == severityOptions[0]}"
                                    (click)="onClickSetConditionType(condition, severityOptions[0]);">Disaster</div>
                                <div *ngIf="condition.get('severity')?.value == severityOptions[1] || !isSeveritySelected(severityOptions[1])"
                                    class="type-button-container"
                                    [ngClass]="{'critical': condition.get('severity')?.value == severityOptions[1], 'text-white': condition.get('severity')?.value == severityOptions[1]}"
                                    (click)="onClickSetConditionType(condition, severityOptions[1]);">Critical</div>
                                <div *ngIf="condition.get('severity')?.value == severityOptions[2] || !isSeveritySelected(severityOptions[2])"
                                    class="type-button-container"
                                    [ngClass]="{'major': condition.get('severity')?.value == severityOptions[2]}"
                                    (click)="onClickSetConditionType(condition, severityOptions[2]);">Major</div>
                                <div *ngIf="condition.get('severity')?.value == severityOptions[3] || !isSeveritySelected(severityOptions[3])"
                                    class="type-button-container"
                                    [ngClass]="{'warning': condition.get('severity')?.value == severityOptions[3]}"
                                    (click)="onClickSetConditionType(condition, severityOptions[3]);">Warning</div>
                            </div>
                            <input type="text" pInputText [pSize]="'small'" [ngModel]="conditionTextMap.get(i)"
                                style="width: 100%;" [readOnly]="true" />
                            <div class="condition-status-container" [formGroup]="condition">
                                <p-toggleswitch formControlName="status" />
                                <span class="font-14">Habilitada</span>
                            </div>
                            <div *ngIf="(conditionArray.controls.length > 1 && mode == 'create') || (mode == 'edit' && condition.get('conditionId')?.value == null)"
                                style="width: 2px; height: 32px; background-color: lightgray;"></div>
                            <p-button
                                *ngIf="(conditionArray.controls.length > 1 && mode == 'create') || (mode == 'edit' && condition.get('conditionId')?.value == null)"
                                [pTooltip]="'Eliminar condición'" tooltipPosition="top" showDelay="1000"
                                icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
                                (onClick)="onClickRemoveSelectedThreshold(i);" />
                        </div>
                        <div class="condition-clause"
                            *ngFor="let clause of condition.controls.clauses.controls; let j = index; let first = first;"
                            [formGroup]="clause">
                            <div class="fields">
                                <div *ngIf="clause.get('startBrackets')?.value">
                                    <span
                                        *ngFor="let startBracket of [].constructor(clause.get('startBrackets')?.value)">(
                                    </span>
                                </div>
                                <div *ngIf="this.alertType == 'composite'" class="bracket-buttons">
                                    <div class="add-bracket-button" (click)="addStartBracket(j, i);">
                                        <div class="font-w-600" style="height: 24px;">(</div>
                                    </div>
                                    <div class="remove-bracket-button"
                                        *ngIf="clause.get('startBrackets')?.value && clause.get('startBrackets')?.value! > 0"
                                        (click)="removeStartBracket(j, i);">
                                        <div class="font-w-600" style="height: 24px; color: red;">x</div>
                                    </div>
                                </div>
                                <p-select *ngIf="!first" [options]="externalOperationOptions"
                                    formControlName="externalOperation" [size]="'small'" />
                                <p-select *ngIf="alertType == 'composite'" [options]="indicatorNames" formControlName="indicatorName" [size]="'small'" />
                                <p-select formControlName="comparation" class="select"
                                    [options]="clauseComparationOptions" optionLabel="label" appendTo="body"
                                    size="small" />
                                <p-inputnumber class="threshold-value"
                                    *ngIf="clause.get('comparation')?.value.value == 'MORE_THAN' || clause.get('comparation')?.value.value == 'LESS_THAN'"
                                    formControlName="value" mode="decimal" [minFractionDigits]="0"
                                    [maxFractionDigits]="6" size="small" placeholder="Valor" />
                                <div *ngIf="clause.get('comparation')?.value.value == 'WITHIN_RANGE' || clause.get('comparation')?.value.value == 'OUT_OF_RANGE'"
                                    class="range-container">
                                    <div>
                                        <p-checkbox formControlName="minIncluded" [binary]="true" size="small" />
                                        &nbsp;
                                        <label>Incl.</label>
                                    </div>
                                    <p-inputnumber class="threshold-value" formControlName="min" mode="decimal"
                                        [minFractionDigits]="0" [maxFractionDigits]="6" size="small"
                                        placeholder="Min" />
                                    -
                                    <p-inputnumber class="threshold-value" formControlName="max" mode="decimal"
                                        [minFractionDigits]="0" [maxFractionDigits]="6" size="small"
                                        placeholder="Max" />
                                    <div>
                                        <p-checkbox formControlName="maxIncluded" [binary]="true" size="small" />
                                        &nbsp;
                                        <label>Incl.</label>
                                    </div>
                                </div>
                                <div *ngIf="this.alertType == 'composite'" class="bracket-buttons">
                                    <div class="add-bracket-button" (click)="addEndBracket(j, i);">
                                        <div class="font-w-600" style="height: 24px;">)</div>
                                    </div>
                                    <div class="remove-bracket-button"
                                        *ngIf="clause.get('endBrackets')?.value && clause.get('endBrackets')?.value! > 0"
                                        (click)="removeEndBracket(j, i);">
                                        <div class="font-w-600" style="height: 24px; color: red;">x</div>
                                    </div>
                                </div>
                                <div *ngIf="clause.get('endBrackets')?.value">
                                    <span
                                        *ngFor="let startBracket of [].constructor(clause.get('endBrackets')?.value)">)
                                    </span>
                                </div>
                            </div>
                            <div *ngIf="this.alertType == 'composite'" class="buttons">
                                <p-button icon="pi pi-plus" severity="primary" (onClick)="createClause(i);" />
                                <p-button *ngIf="condition.controls.clauses.length > 1" icon="pi pi-minus"
                                    severity="secondary" (onClick)="removeClause(i, j);" />
                            </div>
                        </div>
                        <div *ngIf="this.groupByForm.get('groupBy')?.value.length > 0" class="separator"></div>
                        <div *ngIf="this.groupByForm.get('groupBy')?.value.length > 0" class="condition-dimensions">
                            <p-multiselect
                                *ngFor="let dimension of this.groupByForm.get('groupBy')?.value; let i = index;"
                                class="multiselect" [options]="dimensionValuesMap.get(dimension)"
                                [ngModel]="dimensionValuesMap.get(dimension)"
                                (onChange)="onChangeDimensionValuesSelection(condition, dimension, $event);"
                                appendTo="body" size="small" placeholder="{{dimension}}" [maxSelectedLabels]="1" />
                        </div>
                    </div>
                </div>

                <p-button *ngIf="conditionArray.length < 4" label="Añadir otra condición" icon="pi pi-plus"
                    (onClick)="createCondition();" severity="secondary" />

                <app-inner-accordion [title]="'Opciones de activación y recuperación'"
                    [isOpen]="mode == 'edit' ? true : false">
                    <form class="activation-recover-block-container" [formGroup]="activationRecoverForm">
                        <div class="activation-recover-container">
                            <div class="activation-recover-container-title">
                                <div class="icon-wrapper"><i class="pi pi-bell text-white"
                                        style="font-size: 0.7rem"></i></div>
                                <div class="font-16 text-gray font-w-600">Configuración de activación de la alerta</div>
                            </div>
                            <div class="activation-recover-card">
                                <div>¿Cuántas evaluaciones deben fallar para activar la alerta?</div>
                                <div class="activation-recover-card-data">
                                    <p-select [options]="activationRecoverEvaluationOptions" size="small" class="select"
                                        optionLabel="label" appendTo="body" formControlName="activation1" />
                                    <div class="font-16">de las últimas</div>
                                    <p-select [options]="activationRecoverEvaluationOptions" size="small" class="select"
                                        optionLabel="label" appendTo="body" formControlName="activation2" />
                                    <div class="font-16">evaluaciones</div>
                                </div>
                                <div class="font-12 text-gray font-w-600">Ejemplo: La alerta se activa si en
                                    {{activationRecoverForm.get('activation1')?.value.label}} de los últimas
                                    {{activationRecoverForm.get('activation2')?.value.label}} evaluaciones falla</div>
                                <div class="activation-recover-card-time">
                                    <i class="pi pi-clock"></i>
                                    <div class="font-16">Tiempo: <span class="font-w-600">Entre {{getActivationTime1()}}
                                            y {{getActivationTime2()}}</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="activation-recover-container">
                            <div class="activation-recover-container-title">
                                <div class="icon-wrapper"><i class="pi pi-check text-white"
                                        style="font-size: 0.5rem"></i></div>
                                <div class="font-16 text-gray font-w-600">Configuración de recuperación (desactivación
                                    de la alerta)</div>
                            </div>
                            <div class="activation-recover-card">
                                <div>¿Cuántas evaluaciones deben fallar para desactivar la alerta?</div>
                                <div class="activation-recover-card-data">
                                    <p-select [options]="activationRecoverEvaluationOptions" size="small" class="select"
                                        optionLabel="label" appendTo="body" formControlName="recover1" />
                                    <div class="font-16">de las últimas</div>
                                    <p-select [options]="activationRecoverEvaluationOptions" size="small" class="select"
                                        optionLabel="label" appendTo="body" formControlName="recover2" />
                                    <div class="font-16">evaluaciones</div>
                                </div>
                                <div class="font-12 text-gray font-w-600">Ejemplo: La alerta se desactiva si en
                                    {{activationRecoverForm.get('recover1')?.value.label}} de las últimas
                                    {{activationRecoverForm.get('recover2')?.value.label}} evaluaciones falla</div>
                                <div class="activation-recover-card-time">
                                    <i class="pi pi-clock"></i>
                                    <div class="font-16">Tiempo: <span class="font-w-600">Entre {{getRecoverTime1()}} y
                                            {{getRecoverTime2()}}</span></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </app-inner-accordion>

                <app-inner-accordion [title]="'Periodos de silencio'" [isOpen]="mode == 'edit' ? true : false">
                    <div class="silence-periods-container">

                        <div *ngIf="!silencePeriodArray.valid" class="error c-red">
                            <i class="pi pi-info-circle"></i>
                            <div>
                                <span class="font-w-700">Error</span>: Existen periodos de silencio con errores. La hora
                                de fin debe ser mayor a la hora de inicio.
                            </div>
                        </div>

                        <div class="silence-period-container"
                            *ngFor="let silencePeriod of silencePeriodArray.controls; let i = index;"
                            [formGroup]="silencePeriod"
                            [ngStyle]="{'outline': silencePeriod.valid ? '0px' : '2px solid red'}">
                            <div class="checkboxes-container">
                                <i class="pi pi-calendar c-blue"></i>
                                <div *ngFor="let silencePeriodDay of silencePeriodDayOptions;"
                                    style="display: flex; flex-direction: row; align-items: center; gap: 8px;">
                                    <p-checkbox size="small" inputId="{{silencePeriodDay.value}}"
                                        [value]="silencePeriodDay" name="days" formControlName="days"
                                        [binary]="false" />
                                    <label class="font-w-600" for="{{silencePeriodDay.value}}">
                                        {{silencePeriodDay.label}} </label>
                                </div>
                            </div>
                            <div class="times-container">
                                <i class="pi pi-clock c-blue"></i>
                                <div>De</div>
                                <p-datepicker class="datepicker"
                                    [ngClass]="{'disabled': mode == 'edit' && silencePeriodArray.at(i).get('stored')?.value!}"
                                    [ngStyle]="{'pointer-events': mode == 'edit' && silencePeriodArray.at(i).get('stored')?.value! ? 'none' : 'default'}"
                                    size="small" [timeOnly]="true" formControlName="from" />
                                <div>a</div>
                                <p-datepicker class="datepicker"
                                    [ngClass]="{'disabled': mode == 'edit' && silencePeriodArray.at(i).get('stored')?.value!}"
                                    [ngStyle]="{'pointer-events': mode == 'edit' && silencePeriodArray.at(i).get('stored')?.value! ? 'none' : 'default'}"
                                    size="small" [timeOnly]="true" formControlName="to" />
                            </div>
                            <p-button [pTooltip]="'Eliminar periodo de silencio'" tooltipPosition="top" showDelay="1000"
                                icon="pi pi-minus" [rounded]="true" [text]="true" severity="danger"
                                (onClick)="deleteSilencePeriod(i);" />
                        </div>

                        <p-button label="Añadir otro periodo de silencio" icon="pi pi-plus"
                            (onClick)="createSilencePeriod();" severity="secondary" />
                    </div>
                </app-inner-accordion>

                <!-- <app-inner-accordion [title]="'Comportamiento ante errores'">
                    <form class="error-behavior-container" [formGroup]="errorBehaviorForm">
                        <div class="error-behavior-line">
                            <div class="icon-title">
                                <i class="pi pi-database"></i>
                                <div class="font-w-600">¿Qué quieres hacer si la query no devuelve datos?</div>
                            </div>
                            <p-select [options]="errorBehaviorOptions" size="small" class="select" optionLabel="label" appendTo="body" formControlName="error1"/>
                        </div>

                        <div class="error-behavior-line">
                            <div class="icon-title">
                                <i class="pi pi-database"></i>
                                <div class="font-w-600">¿Qué quieres hacer si la query falla y hace timeout?</div>
                            </div>
                            <p-select [options]="errorBehaviorOptions" size="small" class="select" optionLabel="label" appendTo="body" formControlName="error2"/>
                        </div>
                    </form>
                </app-inner-accordion> -->
            </div>
        </app-accordion>

        <p-skeleton *ngIf="isInitialMetricListLoading" width="1460px" height="450px" borderRadius="8px" />

        <app-accordion *ngIf="!isInitialMetricListLoading" [title]="'Paso 3: Configura los destinatarios de la alerta'"
            [highlightTitle]="true"
            [disabled]="indicatorArray.length == 0 || indicatorArray.at(0).controls.metrics.length == 0"
            [isOpen]="mode == 'edit' ? true : false">
            <div class="step-3-container">
                <div class="endpoint-list-container">
                    <div class="font-20 font-w-600">Lista de endpoints</div>
                    <div class="font-16">Define cómo y donde quieres recibir las alertas según su nivel de criticidad.
                    </div>
                    <div class="endpoint-form-container" [formGroup]="endpointForm">
                        <div class="endpoint-form-data-container">
                            <p-select [options]="endpointTypeOptions" optionLabel="label" appendTo="body"
                                placeholder="Selecciona un tipo" formControlName="type"
                                (onChange)="onChangeStep3EndpointType();" />
                            <p-select [options]="endpointFieldValues" class="select" optionLabel="name" appendTo="body"
                                placeholder="Selecciona un endpoint" formControlName="endpoint" />
                            <p-multiselect [options]="this.severityOptions" class="select" optionLabel="label"
                                optionDisabled="disabled" placeholder="Selecciona las severidades"
                                formControlName="severities" />
                        </div>
                        <p-button label="Añadir" icon="pi pi-plus" severity="secondary" [disabled]="!endpointForm.valid"
                            (onClick)="onClickAddEndpoint();" />
                    </div>
                    <div *ngIf="endpointList.length > 0" class="channel-list-container">
                        <div class="font-16 font-w-600">Endpoints definidos</div>
                        <div class="channel-container" *ngFor="let endpoint of endpointList; let i = index;">
                            <div class="channel-data-container">
                                <input size="small" type="text" pInputText [(ngModel)]="endpoint.type.label"
                                    readonly="readonly" [ngStyle]="{'pointer-events': 'none'}" />
                                <input size="small" type="text" pInputText [(ngModel)]="endpoint.endpoint.name"
                                    readonly="readonly" [ngStyle]="{'pointer-events': 'none'}" />
                            </div>

                            <div class="alerts-container">
                                <div *ngIf="endpoint.severities.includes(this.severityOptions[0])"
                                    class="type-button-container disaster">Disaster</div>
                                <div *ngIf="endpoint.severities.includes(this.severityOptions[1])"
                                    class="type-button-container critical">Critical</div>
                                <div *ngIf="endpoint.severities.includes(this.severityOptions[2])"
                                    class="type-button-container major">Major</div>
                                <div *ngIf="endpoint.severities.includes(this.severityOptions[3])"
                                    class="type-button-container warning">Warning</div>
                            </div>
                            <p-button [pTooltip]="'Eliminar endpoint'" tooltipPosition="top" showDelay="1000"
                                icon="pi pi-minus" [rounded]="true" [text]="true" severity="danger"
                                (onClick)="onClickDeleteEndpoint(i);" />
                        </div>
                    </div>
                </div>
                <div class="add-label-container">
                    <div class="font-20 font-w-600">Añadir etiqueta</div>
                    <div class="font-16">Añade etiquetas personalizadas para categorizar y organizar mejor tus alertas.
                        Estas etiquetas pasarán a formar parte de los metadatos de la alerta.</div>
                    <form [formGroup]="tagForm">
                        <div class="add-label-fields">
                            <p-floatlabel class="floatlabel" variant="on">
                                <input class="input" pInputText id="name" formControlName="name" />
                                <label for="name">Nombre *</label>
                            </p-floatlabel>
                            <p-floatlabel class="floatlabel" variant="on">
                                <input class="input" pInputText id="value" formControlName="value" />
                                <label for="value">Valor *</label>
                            </p-floatlabel>
                        </div>
                        <p-button label="Añadir etiqueta" icon="pi pi-plus" (onClick)="onClickAddTag();"
                            severity="secondary" [disabled]="!tagForm.valid" />
                    </form>
                    <div *ngIf="tagList.length > 0" class="font-16 font-w-600">Etiquetas añadidas</div>
                    <div *ngIf="tagList.length > 0" class="labels-container">
                        <div class="label-container" *ngFor="let tag of tagList; let i = index;">
                            <i class="pi pi-tag" style="font-size: 0.75rem;"></i>
                            <div class="font-12">{{tag.name + ': ' + tag.value}}</div>
                            <i class="pi pi-times remove-icon" style="font-size: 0.75rem;"
                                (click)="onClickRemoveTag(i);"></i>
                        </div>
                    </div>
                </div>
                <div class="notification-message-container">
                    <div class="font-20 font-w-600">Mensaje de notificación</div>
                    <div class="font-16">Configura el mensaje que se enviará con cada notificación.</div>
                    <div class="notice c-blue">
                        <i class="pi pi-info-circle"></i>
                        <div>
                            <span class="font-w-700">Uso de variables y bloques condicionales</span>: Puedes usar
                            <strong>&#123;&#123;</strong> en los campos de mensaje y detalles para acceder a variables
                            de plantilla (como <strong>host.name</strong>) y bloques condicionales (como
                            <strong>#is_alert</strong>)
                        </div>
                    </div>

                    <p-tabs class="tabs" value="0">
                        <p-tablist>
                            <p-tab style="width: 50%;" value="0">
                                <i class="pi pi-pencil"></i>
                                <div>Edición</div>
                            </p-tab>
                            <p-tab style="width: 50%;" value="1">
                                <i class="pi pi-eye"></i>
                                <div>Previsualización</div>
                            </p-tab>
                        </p-tablist>
                        <p-tabpanels>
                            <p-tabpanel value="0">
                                <form [formGroup]="notificationMessageForm">
                                    <div class="notification-message-form">
                                        <label class="font-w-600" for="message">Mensaje de la alerta <span
                                                style="color: red;">*</span></label>
                                        <textarea class="full-w-field" pTextarea #message id="message" rows="2"
                                            [autoResize]="true" formControlName="message"
                                            (ngModelChange)="verifyMessageText(message.value, message)"
                                            placeholder="Escribe aquí el mensaje de la alerta. Usa doble llave para ver sugerencias de bloques condicionales y variables..."></textarea>

                                        <label class="font-w-600" for="details">Detalles adicionales</label>
                                        <textarea class="full-w-field" pTextarea #details id="details" rows="2"
                                            [autoResize]="true" formControlName="details"
                                            (ngModelChange)="verifyDetailsText(details.value, details)"
                                            placeholder="Escribe aquí los detalles adicionales de la alerta. Usa doble llave para ver sugerencias de bloques condicionales y variables..."></textarea>

                                        <label class="font-w-600" for="proccedure">Procedimiento (OPI)</label>
                                        <input class="full-w-field" pInputText id="proccedure"
                                            formControlName="proccedure"
                                            placeholder="URL del Procedimiento Operativo (OPI)" />
                                    </div>
                                </form>
                            </p-tabpanel>
                            <p-tabpanel value="1">
                                <div class="notification-message-form">
                                    <label class="font-w-600">Mensaje de la alerta:</label>
                                    <textarea class="full-w-field" pTextarea rows="2" [autoResize]="true"
                                        [ngModel]="notificationMessageForm.get('message')?.value" readonly="readonly"
                                        style="pointer-events: none;"></textarea>

                                    <label class="font-w-600">Detalles adicionales:</label>
                                    <textarea class="full-w-field" pTextarea rows="2" [autoResize]="true"
                                        [ngModel]="notificationMessageForm.get('details')?.value" readonly="readonly"
                                        style="pointer-events: none;"></textarea>

                                    <label class="font-w-600">Procedimiento (OPI):</label>
                                    <input class="full-w-field" pInputText readonly="readonly"
                                        [ngModel]="notificationMessageForm.get('proccedure')?.value"
                                        style="pointer-events: none;" />
                                </div>
                            </p-tabpanel>
                        </p-tabpanels>
                    </p-tabs>
                </div>
            </div>
        </app-accordion>

        <app-accordion *ngIf="!isInitialMetricListLoading"
            [title]="'Paso 4: Configura los aspectos relativos a los permisos'" [highlightTitle]="true"
            [disabled]="indicatorArray.length == 0 || indicatorArray.at(0).controls.metrics.length == 0"
            [isOpen]="mode == 'edit' ? true : false">
            <div class="step-4-container">
                <div class="notice c-blue">
                    <i class="pi pi-info-circle"></i>
                    <div>
                        <span class="font-w-700">Importante</span>: por defecto, tu equipo podrá editar la
                        configuración de la alerta (permiso de lectura y escritura), y todos los demás equipos solo
                        podrán verla. Puedes añadir nuevos equipos, y estos adquirirán permisos de lectura y escritura.
                    </div>
                </div>

                <div class="permissions-container">
                    <div class="permission-container" *ngFor="let permission of permissionList; let i = index;"
                        [ngStyle]="{'border': permission.team == null || permission.type == null ? '2px solid red' : 'none'}">
                        <div class="permission-form-container">
                            <p-select [options]="teamList" class="select" optionLabel="name" appendTo="body"
                                [(ngModel)]="permission.team" placeholder="Selecciona un equipo"
                                [optionDisabled]="'disabled'" [disabled]="i == 0" (onChange)="onChangeTeam($event);" />
                            <div style="display: flex; flex-direction: row; align-items: center; gap: 8px;"
                                *ngFor="let permissionTypeOption of permissionTypeOptions; let j = index;">
                                <p-radiobutton size="small" name="type" [value]="permissionTypeOption"
                                    [(ngModel)]="permission.type" [inputId]="permissionTypeOption.value + j"
                                    [disabled]="true" />
                                <i class="pi {{permissionTypeOption.icon}} c-blue"></i>
                                <label [for]="permissionTypeOption.value + j">{{permissionTypeOption.label}}</label>
                            </div>
                        </div>
                        <p-button *ngIf="permissionList.length > 1 && i > 0" [pTooltip]="'Eliminar permiso'"
                            tooltipPosition="top" showDelay="1000" icon="pi pi-minus" [rounded]="true" [text]="true"
                            severity="danger" (onClick)="deletePermission(i);" />
                    </div>

                    <p-button label="Añadir otro permiso" icon="pi pi-plus" (onClick)="createPermission();"
                        severity="secondary" />
                </div>
            </div>
        </app-accordion>

        <div *ngIf="!isInitialMetricListLoading" class="end-button-container">
            <p-button *ngIf="mode == 'create'" label="Crear alerta" (onClick)="onClickCreateAlert();" severity="primary"
                [disabled]="!checkAllFinalExpressions() || configuredAlertExists || indicatorArray.length == 0 || indicatorArray.at(0).controls.metrics.length == 0 || !allValuesCompleted() || (silencePeriodArray.length > 1 && !allSilencePeriodFieldsCompleted()) || !notificationMessageForm.valid || !allPermissionsCompleted()" />
            <p-button *ngIf="mode == 'edit'" label="Actualizar alerta" (onClick)="onClickCreateAlert();"
                severity="primary"
                [disabled]="!checkAllFinalExpressions() || configuredAlertExists || indicatorArray.length == 0 || indicatorArray.at(0).controls.metrics.length == 0 || !allValuesCompleted() || (silencePeriodArray.length > 1 && !allSilencePeriodFieldsCompleted()) || !notificationMessageForm.valid || !allPermissionsCompleted()" />
        </div>
    </div>
</app-page-wrapper>

<!-- <app-floating-graph></app-floating-graph> -->

<app-modal [title]="mode == 'create' ? 'Crear alerta' : 'Actualizar alerta'" [visible]="modalVisible">
    <div class="modal-container">
        <div *ngIf="!isSuccess && !isError && !isDetails" class="modal-icon-container">
            <i *ngIf="!isLoading && mode == 'create'" class="pi pi-bell" style="font-size: 128px"></i>
            <i *ngIf="!isLoading && mode == 'edit'" class="pi pi-pencil" style="font-size: 128px"></i>
            <i *ngIf="isLoading" class="pi pi-spinner spin" style="font-size: 128px"></i>
            <div class="font-16 font-w-600">Estás a punto de {{mode == 'create' ? 'crear una' : 'actualizar esta'}}
                alerta</div>
            <div class="font-12 text-gray">Ten en cuenta que los cambios no se pueden deshacer. Asegura que todos los
                datos introducidos son correctos <span class="font-w-600 text-black" style="cursor: pointer;"
                    (click)="isDetails = true;">aquí</span>.</div>
        </div>
        <div *ngIf="isSuccess" class="modal-icon-container">
            <i class="pi pi-check-circle c-green" style="font-size: 128px"></i>
            <div class="font-16 font-w-600">Se ha {{mode == 'create' ? 'creado' : 'actualizado'}} la alerta con éxito
            </div>
            <div *ngIf="mode == 'create'" class="font-12 text-gray">Puedes volver a crear otra alerta, ver las alertas
                creadas o volver al
                inicio.</div>
        </div>
        <div *ngIf="isError && !dolphinError" class="modal-icon-container">
            <i class="pi pi-times c-red" style="font-size: 128px"></i>
            <div class="font-16 font-w-600">Ha habido algún error desconocido al {{mode == 'create' ? 'crear' : 'actualizar'}} la
                alerta</div>
            <div class="font-12 text-gray"></div>
        </div>
        <div *ngIf="isError && dolphinError" class="modal-icon-container">
            <i class="pi pi-times c-red" style="font-size: 128px"></i>
            <div class="font-16 font-w-600">Ha habido un error al {{mode == 'create' ? 'crear' : 'actualizar'}} la
                alerta en Dolphin</div>
            <div class="font-12 text-gray"></div>
        </div>
    </div>
    <i *ngIf="!isSuccess && !isError && isDetails" class="pi pi-chevron-left"
        style="cursor: pointer; margin-bottom: 16px;" (click)="isDetails = false;"></i>
    <div *ngIf="!isSuccess && !isError && isDetails" class="modal-steps">
        <div class="modal-step">
            <div class="font-16 font-w-700 c-blue">Paso 1: Configuración de la consulta</div>
            <div class="modal-step-content">
                <div class="font-16 font-w-600">Internal name</div>
                <div class="title-description-block-1">
                    <div class="title">{{internalName}}</div>
                </div>
            </div>
            <div class="modal-step-content">
                <div class="font-16 font-w-600">Indicadores</div>
                <div class="title-description-block-1"
                    *ngFor="let indicator of indicatorArray.controls; let i = index;">
                    <div class="title">Indicador {{indicator.get('name')?.value}}</div>
                    <div class="description" *ngFor="let metric of indicator.controls.metrics.controls; let i = index;">
                        {{i+1}}.- {{metric.get('metric')?.value?.metric}}</div>
                    <div class="description">Métrica final: {{ resultMetricMap.get(i)! | sanitizeExpression}}</div>
                </div>
            </div>
            <div class="modal-step-content">
                <div class="font-16 font-w-600">Agrupaciones</div>
                <div class="title-description-block-1">
                    <div class="title">Agrupar por</div>
                    <div class="description">{{groupByForm.get('groupBy')?.value.length == 0 ? 'Sin agrupar' :
                        groupByForm.get('groupBy')?.value}}</div>
                </div>
                <div class="title-description-block-1">
                    <div class="title">Operación matemática</div>
                    <div class="description">{{groupByForm.get('operation')?.value.label}}</div>
                </div>
            </div>
            <div class="modal-step-content">
                <div class="font-16 font-w-600">Opciones avanzadas</div>
                <div class="title-description-block-1">
                    <div class="title">Ventana de tiempo</div>
                    <div class="description">{{advancedOptionsForm.get('timeWindow')?.value.label}}</div>
                </div>
                <div class="title-description-block-1">
                    <div class="title">Descartar últimos minutos</div>
                    <div class="description">{{advancedOptionsForm.get('discardTime')?.value.label}}</div>
                </div>
                <div class="title-description-block-1">
                    <div class="title">Periodicidad</div>
                    <div class="description">{{advancedOptionsForm.get('periodicity')?.value.label}}</div>
                </div>
            </div>
        </div>

        <div class="modal-step">
            <div class="font-16 font-w-700 c-blue">Paso 2: Condiciones de salto y recuperación</div>
            <div class="modal-step-content">
                <div class="font-16 font-w-600">Condiciones seleccionadas</div>
                <div class="title-description-block-1"
                    *ngFor="let condition of conditionArray.controls; let i = index;">
                    <div class="title">Condición {{condition.get('id')?.value}} |
                        {{condition.get('severity')?.value.label}}</div>
                    <div class="description" *ngFor="let clause of condition.controls.clauses.controls; let i = index;">
                        {{clause.get('comparation')?.value.label}} | {{clause.get('comparation')?.value.value ==
                        'MORE_THAN' || clause.get('comparation')?.value.value == 'LESS_THAN' ?
                        clause.get('value')?.value : (clause.get('minIncluded')?.value ? '[' : '(') +
                        clause.get('min')?.value + ', ' + clause.get('max')?.value + (clause.get('maxIncluded')?.value ?
                        ']' : ')')}}</div>
                </div>
            </div>
            <div class="modal-step-content">
                <div class="font-16 font-w-600">Opciones de activación de recuperación</div>
                <div class="title-description-block-1">
                    <div class="title">¿Cuántas evaluaciones deben fallar para activar la alerta?</div>
                    <div class="description">{{activationRecoverForm.get('activation1')?.value.label}} de las últimas
                        {{activationRecoverForm.get('activation2')?.value.label}} evaluaciones</div>
                </div>
                <div class="title-description-block-1">
                    <div class="title">¿Cuántas evaluaciones deben fallar para desactivar la alerta?</div>
                    <div class="description">{{activationRecoverForm.get('recover1')?.value.label}} de las últimas
                        {{activationRecoverForm.get('recover2')?.value.label}} evaluaciones</div>
                </div>
            </div>
            <div *ngIf="allSilencePeriodFieldsCompleted()" class="modal-step-content">
                <div class="font-16 font-w-600">Periodos de silencio</div>
                <div class="title-description-block-1"
                    *ngFor="let silencePeriod of silencePeriodArray.controls; let i = index;">
                    <div class="title">Periodo de silencio {{silencePeriod.get('id')?.value}}</div>
                    <div class="description">
                        <span
                            *ngFor="let day of silencePeriod.get('days')?.value; let i = index; let last = last;">{{day?.label}}<span
                                *ngIf="!last">, </span></span> | De {{silencePeriod.get('from')?.value | date: 'HH:mm'}}
                        a {{silencePeriod.get('to')?.value | date: 'HH:mm'}}
                    </div>
                </div>
            </div>
            <div *ngIf="!allSilencePeriodFieldsCompleted()" class="modal-step-content">
                <div class="font-16 font-w-600">Periodos de silencio</div>
                <div class="title-description-block-1"
                    *ngFor="let silencePeriod of silencePeriodArray.controls; let i = index;">
                    <div class="description">No se han añadido periodos de silencio</div>
                </div>
            </div>
            <!-- <div class="modal-step-content">
                <div class="font-16 font-w-600">Comportamiento ante errores</div>
                <div class="title-description-block-1">
                    <div class="title">¿Qué quieres hacer si la query no devuelve datos?</div>
                    <div class="description">{{errorBehaviorForm.get('error1')?.value.label}}</div>
                </div>
                <div class="title-description-block-1">
                    <div class="title">¿Qué quieres hacer si la query falla y hace timeout?</div>
                    <div class="description">{{errorBehaviorForm.get('error2')?.value.label}}</div>
                </div>
            </div> -->
        </div>

        <div class="modal-step">
            <div class="font-16 font-w-700 c-blue">Paso 3: Destinatarios</div>
            <div class="modal-step-content">
                <div class="font-16 font-w-600">Endpoints seleccionados</div>
                <div class="title-description-block-1" *ngFor="let endpoint of endpointList; let i = index;">
                    <div class="description">{{endpoint.endpoint.name}}</div>
                    <div class="description">{{endpoint.type.label}}</div>
                    <div class="description">
                        <span *ngFor="let severity of endpoint.severities; let last = last;">{{severity.label}}<span
                                *ngIf="!last">, </span></span>
                    </div>
                </div>
                <div *ngIf="endpointList.length == 0" class="title-description-block-1">
                    <div class="description">No se ha añadido ningún endpoint</div>
                </div>
            </div>
            <div *ngIf="tagList.length > 0" class="modal-step-content">
                <div class="font-16 font-w-600">Etiquetas añadidas</div>
                <div class="title-description-block-1" *ngFor="let tag of tagList; let i = index;">
                    <div class="title">Etiqueta {{(i + 1)}}</div>
                    <div class="description">{{tag.name}}</div>
                    <div class="description">{{tag.value}}</div>
                </div>
            </div>
            <div *ngIf="tagList.length == 0" class="modal-step-content">
                <div class="font-16 font-w-600">Etiquetas añadidas</div>
                <div class="title-description-block-1">
                    <div class="description">No se han añadido etiquetas</div>
                </div>
            </div>
            <div class="modal-step-content">
                <div class="font-16 font-w-600">Mensaje</div>
                <div class="title-description-block-1" style="max-width: 1000px;">
                    <div class="title">Mensaje</div>
                    <div class="description">{{notificationMessageForm.get('message')?.value}}</div>
                </div>
                <div class="title-description-block-1" style="max-width: 1000px;">
                    <div class="title">Detalles</div>
                    <div *ngIf="notificationMessageForm.get('details')?.value.length > 0" class="description">
                        {{notificationMessageForm.get('details')?.value}}</div>
                    <div *ngIf="notificationMessageForm.get('details')?.value.length == 0" class="description">No se han
                        especificado detalles</div>
                </div>
                <div class="title-description-block-1" style="max-width: 1000px;">
                    <div class="title">Procedimiento</div>
                    <div *ngIf="notificationMessageForm.get('proccedure')?.value.length > 0" class="description">
                        {{notificationMessageForm.get('proccedure')?.value}}</div>
                    <div *ngIf="notificationMessageForm.get('proccedure')?.value.length == 0" class="description">No se
                        ha especificado procedimiento</div>
                </div>
            </div>
        </div>

        <div class="modal-step">
            <div class="font-16 font-w-700 c-blue">Paso 4: Permisos</div>
            <div class="modal-step-content">
                <div class="font-16 font-w-600">Permisos añadidos</div>
                <div class="title-description-block-1" *ngFor="let permission of permissionList; let i = index;">
                    <div class="title">{{permission.team.name}}</div>
                    <div class="description">{{permission.type.label}}</div>
                </div>
            </div>
        </div>
    </div>
    <div *ngIf="!isSuccess && !isError" class="modal-actions">
        <p-button label="Volver" severity="secondary" (onClick)="modalVisible = false;" />
        <p-button label="Confirmar" severity="primary" (onClick)="isDetails = false; onClickConfirmCrupdateAlert();"
            [loading]="isLoading" />
    </div>
    <div *ngIf="isSuccess" class="modal-actions">
        <p-button label="Volver atrás" severity="secondary" (onClick)="onClickGoToCreateAlert();" />
        <p-button label="Mis alertas" severity="primary" (onClick)="onClickGoToMofifyAlert();" />
    </div>
    <div *ngIf="isError && !dolphinError" class="modal-actions">
        <p-button label="Volver atrás" severity="secondary" (onClick)="onClickGoToCreateAlert();" />
        <p-button label="Reintentar" severity="primary" (onClick)="onClickConfirmCrupdateAlert();" />
    </div>
    <div *ngIf="isError && dolphinError" class="modal-actions">
        <p-button label="Volver atrás" severity="secondary" (onClick)="onClickGoToCreateAlert();" />
        <p-button label="Mis alertas" severity="primary" (onClick)="onClickGoToMofifyAlert();" />
    </div>
</app-modal>

<p-dialog [(visible)]="messageModalVisible" [modal]="false" [closable]="false" [resizable]="false" [showHeader]="false"
    [style]="messageDialogStyle" (click)="$event.stopPropagation();">
    <div class="notification-modal-content">
        <div class="notification-modal-title">
            <div class="font-20 c-blue font-w-700">#</div>
            <div class="font-16 font-w-600">Bloques condicionales</div>
        </div>
        <div class="options-container">
            <div class="option-container" *ngFor="let conditionalBlockOption of conditionalBlockOptions; let i = index;"
                (click)="onClickAddConditionalBlockToMessage(i);">
                <div class="font-12 font-w-600 title">{{conditionalBlockOption.label}}</div>
                <div class="font-12 text-gray">{{conditionalBlockOption.description}}</div>
            </div>
        </div>
        <div class="notification-modal-title">
            <div class="font-20 c-green font-w-700">&#123;x&#125;</div>
            <div class="font-16 font-w-600">Variables de plantilla</div>
        </div>
        <div class="options-container">
            <div class="option-container"
                *ngFor="let groupByOption of groupByForm.get('groupBy')?.value; let i = index;"
                (click)="onClickAddTagTemplateVariableToMessage(i);">
                <div class="font-12 font-w-600 title">{{groupByOption}}</div>
                <div class="font-12 text-gray">{{groupByOption}}</div>
            </div>
            <div class="option-container" *ngFor="let templateVariableOption of templateVariableOptions; let i = index;"
                (click)="onClickAddTemplateVariableToMessage(i);">
                <div class="font-12 font-w-600 title">{{templateVariableOption.label}}</div>
                <div class="font-12 text-gray">{{templateVariableOption.description}}</div>
            </div>
        </div>
    </div>
</p-dialog>

<p-dialog [(visible)]="detailsModalVisible" [modal]="false" [closable]="false" [resizable]="false" [showHeader]="false"
    [style]="detailsDialogStyle" (click)="$event.stopPropagation();">
    <div class="notification-modal-content">
        <div class="notification-modal-title">
            <div class="font-20 c-blue font-w-700">#</div>
            <div class="font-16 font-w-600">Bloques condicionales</div>
        </div>
        <div class="options-container">
            <div class="option-container" *ngFor="let conditionalBlockOption of conditionalBlockOptions; let i = index;"
                (click)="onClickAddConditionalBlockToDetails(i);">
                <div class="font-12 font-w-600 title">{{conditionalBlockOption.label}}</div>
                <div class="font-12 text-gray">{{conditionalBlockOption.description}}</div>
            </div>
        </div>
        <div class="notification-modal-title">
            <div class="font-20 c-green font-w-700">&#123;x&#125;</div>
            <div class="font-16 font-w-600">Variables de plantilla</div>
        </div>
        <div class="options-container">
            <div class="option-container" *ngFor="let templateVariableOption of templateVariableOptions; let i = index;"
                (click)="onClickAddTemplateVariableToDetails(i);">
                <div class="font-12 font-w-600 title">{{templateVariableOption.label}}</div>
                <div class="font-12 text-gray">{{templateVariableOption.description}}</div>
            </div>
        </div>
    </div>
</p-dialog>

<div *ngIf="configuredAlertExists" class="toast bg-yellow">
    <div class="c-yellow title">
        <i class="pi pi-info-circle" style="font-size: 1.2rem;"></i>
        <div class="font-16 font-w-600">Alerta duplicada</div>
    </div>
    <div class="c-yellow description">
        La alerta que estás configurando ya existe. Si quieres acceder a ella, pulsa <span class="font-w-700"
            style="cursor: pointer;" (click)="onClickGoToAlert();">aquí</span>.
    </div>

</div>